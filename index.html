<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма заявки на поставку груза</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #f5f5f5;
            --tg-theme-text-color: #333;
            --tg-theme-hint-color: #999;
            --tg-theme-link-color: #2678b6;
            --tg-theme-button-color: #3498db;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f0f0f0;
            
            /* Дополнительные переменные для улучшения контрастности */
            --tab-bg-color: rgba(255, 255, 255, 0.2);
            --tab-active-bg-color: rgba(255, 255, 255, 0.3);
            --tab-text-color: #ffffff;
            --label-color: #ffffff;
            --border-color: rgba(255, 255, 255, 0.3);
            --checkbox-border-color: rgba(255, 255, 255, 0.5);
            --option-bg-color: rgba(255, 255, 255, 0.1);
            --option-hover-bg-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Светлая тема */
        .light-theme {
            --tg-theme-bg-color: #f5f5f5;
            --tg-theme-text-color: #333;
            --tg-theme-hint-color: #999;
            --tg-theme-link-color: #2678b6;
            --tg-theme-button-color: #3498db;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f0f0f0;
            
            --tab-bg-color: #e0e0e0;
            --tab-active-bg-color: #ffffff;
            --tab-text-color: #333333;
            --label-color: #333333;
            --border-color: rgba(0, 0, 0, 0.2);
            --checkbox-border-color: rgba(0, 0, 0, 0.3);
            --option-bg-color: #f0f0f0;
            --option-hover-bg-color: #e5e5e5;
        }
        
        /* Темная тема */
        .dark-theme {
            --tg-theme-bg-color: #222;
            --tg-theme-text-color: #fff;
            --tg-theme-hint-color: #aaa;
            --tg-theme-link-color: #64b5f6;
            --tg-theme-button-color: #50a8e6;
            --tg-theme-button-text-color: #fff;
            --tg-theme-secondary-bg-color: #333;
            
            --tab-bg-color: rgba(255, 255, 255, 0.2);
            --tab-active-bg-color: rgba(255, 255, 255, 0.3);
            --tab-text-color: #ffffff;
            --label-color: #ffffff;
            --border-color: rgba(255, 255, 255, 0.3);
            --checkbox-border-color: rgba(255, 255, 255, 0.5);
            --option-bg-color: rgba(255, 255, 255, 0.1);
            --option-hover-bg-color: rgba(255, 255, 255, 0.2);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 16px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--tg-theme-bg-color);
            padding: 16px;
            border-radius: 8px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color);
            font-size: 24px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--label-color);
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
        
        select:focus, input:focus, textarea:focus {
            border-color: var(--tg-theme-button-color);
            outline: none;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        .input-group select {
            width: 120px;
        }
        
        select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: opacity 0.3s;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            display: block;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .address-display {
            margin-top: 10px;
            padding: 12px;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--tg-theme-text-color);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: var(--tg-theme-hint-color);
        }
        
        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            background-color: var(--tab-bg-color);
            color: var(--tab-text-color);
            position: relative;
        }
        
        .tab.active {
            background-color: var(--tab-active-bg-color);
            border-bottom: 1px solid var(--tab-active-bg-color);
            margin-bottom: -1px;
            font-weight: 500;
        }
        
        .tab-close {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 14px;
            text-align: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            color: var(--tab-text-color);
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
            cursor: pointer;
            vertical-align: middle;
        }
        
        .tab-close:hover {
            background-color: rgba(231, 76, 60, 0.7);
            color: #fff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .add-tab-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 30px;
            max-width: 30px;
        }
        
        .add-tab-btn:hover {
            opacity: 0.9;
        }
        
        .customer-info {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            color: var(--tg-theme-text-color);
        }
        
        .customer-info h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
            color: var(--tg-theme-text-color);
        }
        
        .customer-info p {
            margin: 5px 0;
            color: var(--tg-theme-text-color);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--tg-theme-button-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Стили для радио-кнопок и чекбоксов */
        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
        }
        
        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            background-color: var(--option-bg-color);
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
        }
        
        .radio-option:hover, .checkbox-option:hover {
            background-color: var(--option-hover-bg-color);
        }
        
        .radio-option input, .checkbox-option input {
            width: auto;
            margin-right: 10px;
            accent-color: var(--tg-theme-button-color);
        }
        
        /* Стиль для label внутри option */
        .radio-option label, .checkbox-option label {
            margin-bottom: 0;
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
        }
        
        /* Улучшенный внешний вид checkbox-кнопок */
        .checkbox-option {
            flex-direction: row;
        }
        
        /* Переключатель темы */
        .theme-switch-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-switch-label {
            margin-right: 10px;
            color: var(--tg-theme-text-color);
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            z-index: 2;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .slider .light-icon,
        .slider .dark-icon {
            position: relative;
            z-index: 1;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            line-height: 1;
            text-align: center;
        }
        
        /* На мобильных устройствах меньший размер эмодзи */
        @media (max-width: 768px) {
            .slider .light-icon,
            .slider .dark-icon {
                font-size: 12px;
            }
        }
        
        .slider .light-icon {
            color: #fff;
            margin-right: 4px;
        }
        
        .slider .dark-icon {
            color: #333;
            margin-left: 4px;
        }
        
        /* Стили для временного диапазона */
        .time-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .time-range select {
            flex: 1;
        }
        
        /* Мобильные стили */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 12px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            select, input, textarea {
                padding: 10px;
                font-size: 16px;
            }
            
            .radio-group, .checkbox-group {
                gap: 8px;
            }
        }
        
        .pickup-warning {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 96, 64, 0.512);
            border: 1px solid #dc4949;
            border-radius: 8px;
            color: #f98964;
        }
        
        .pickup-warning p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .warning-message {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 96, 64, 0.512);
            border: 1px solid #dc4949;
            border-radius: 8px;
            color: #f98964;
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="theme-switch-container">
            <span class="theme-switch-label">Тема:</span>
            <label class="theme-switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider">
                    <span class="light-icon">🌕</span>
                    <span class="dark-icon">🌑</span>
                </span>
            </label>
        </div>
        
        <h1>Заявка на поставку груза</h1>
        
        <div id="telegramUserInfo" class="customer-info hidden">
            <h3>Информация о клиенте</h3>
            <p>ID пользователя: <span id="telegramUserId">Загрузка...</span></p>
            <p>Имя: <span id="telegramUserName">Загрузка...</span></p>
        </div>
        
        <div id="loading" class="loading">
            Загрузка данных из таблицы...
        </div>
        
        <div id="error" class="error hidden">
            Ошибка загрузки данных из таблицы. Проверьте доступ к таблице или обновите страницу.
        </div>
        
        <div id="tabsContainer" class="hidden">
            <div class="tabs" id="tabs">
                <div class="tab active" data-tab-id="tab1">Заказ 1</div>
                <button id="addTabBtn" class="add-tab-btn" title="Добавить заказ">+</button>
            </div>
            
            <form id="cargoFormMain">
                <div id="tab1" class="tab-content active">
                    <!-- Форма будет добавлена динамически -->
                </div>
                
                <button type="submit" id="submitButton">Отправить заявку</button>
            </form>
        </div>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <!-- Шаблон формы (будет клонирован для каждой вкладки) -->
    <template id="formTemplate">
        <div class="form-content">
            <div class="form-group">
                <label for="branch-{tabId}">Филиал:</label>
                <select id="branch-{tabId}" class="branch" required>
                    <option value="">Выберите филиал</option>
                </select>
            </div>

            <div class="form-group">
                <label for="marketplace-{tabId}">Маркетплейс:</label>
                <select id="marketplace-{tabId}" class="marketplace" required disabled>
                    <option value="">Сначала выберите филиал</option>
                </select>
            </div>

            <div class="form-group">
                <label for="city-{tabId}">Город:</label>
                <select id="city-{tabId}" class="city" required disabled>
                    <option value="">Сначала выберите маркетплейс</option>
                </select>
            </div>

            <div class="form-group">
                <label for="warehouse-{tabId}">Склад:</label>
                <select id="warehouse-{tabId}" class="warehouse" required disabled>
                    <option value="">Сначала выберите город</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Адрес склада:</label>
                <div id="address-{tabId}" class="address-display">Адрес появится после выбора склада</div>
            </div>
            
            <div class="form-group">
                <label for="marketplaceShipmentDate-{tabId}">Дата отгрузки на маркетплейс:</label>
                <select id="marketplaceShipmentDate-{tabId}" class="marketplaceShipmentDate" required disabled>
                    <option value="">Сначала выберите склад</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="ncgShipmentDate-{tabId}">Дата отгрузки к нам на склад NCG:</label>
                <select id="ncgShipmentDate-{tabId}" class="ncgShipmentDate" required disabled>
                    <option value="">Сначала выберите дату отгрузки на маркетплейс</option>
                </select>
                <div id="ncg-date-warning-{tabId}" class="warning-message">В последний возможный для отгрузки день можно привезти груз ТОЛЬКО до 12:00</div>
            </div>
            
            <div class="form-group">
                <label>Вид упаковки товара:</label>
                <div class="radio-group package-type-group">
                    <div class="radio-option">
                        <input type="radio" id="packageTypeBox-{tabId}" name="packageType-{tabId}" class="packageType" value="короб">
                        <label for="packageTypeBox-{tabId}">Короб</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="packageTypePallet-{tabId}" name="packageType-{tabId}" class="packageType" value="паллета">
                        <label for="packageTypePallet-{tabId}">Паллета</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="packageTypeMonopallet-{tabId}" name="packageType-{tabId}" class="packageType" value="монопаллета">
                        <label for="packageTypeMonopallet-{tabId}">Монопаллета</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="package_places-{tabId}">Количество грузомест:</label>
                <input type="number" id="package_places-{tabId}" class="package_places" min="1" required>
            </div>

            <div class="form-group box-count-field hidden">
                <label for="boxCount-{tabId}">Общее количество коробов:</label>
                <input type="number" id="boxCount-{tabId}" class="boxCount" min="1">
            </div>
            
            <!-- Общие вопросы для всех типов поставок -->
            <div class="common-questions">
                <div class="form-group">
                    <label>Требуется ли создание упаковочного листа?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="packingListNo-{tabId}" name="packingList-{tabId}" class="packingList" value="нет" checked>
                            <label for="packingListNo-{tabId}">Нет</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="packingListYes-{tabId}" name="packingList-{tabId}" class="packingList" value="да">
                            <label for="packingListYes-{tabId}">Да</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Нужно ли проверить штрихкоды на читаемость?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="barcodeCheckNo-{tabId}" name="barcodeCheck-{tabId}" class="barcodeCheck" value="нет" checked>
                            <label for="barcodeCheckNo-{tabId}">Нет</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="barcodeCheckYes-{tabId}" name="barcodeCheck-{tabId}" class="barcodeCheck" value="да">
                            <label for="barcodeCheckYes-{tabId}">Да</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="cargoWeight-{tabId}">Общий вес груза (кг):</label>
                    <input type="number" id="cargoWeight-{tabId}" class="cargoWeight" min="0" step="0.1" required>
                </div>
            </div>
            
            <!-- Блок для вида "Короб" -->
            <div class="package-box-details hidden">
                <div class="form-group">
                    <label>Требуется ли маркировка коробов?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="boxMarkingNo-{tabId}" name="boxMarking-{tabId}" class="boxMarking" value="нет" checked>
                            <label for="boxMarkingNo-{tabId}">Нет</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="boxMarkingYes-{tabId}" name="boxMarking-{tabId}" class="boxMarking" value="да">
                            <label for="boxMarkingYes-{tabId}">Да</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Блок для вида "Паллета" или "Монопаллета" -->
            <div class="package-pallet-details hidden">
                <div class="form-group">
                    <label>В каком виде прибудет груз на склад NCG?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="cargoTypeReady-{tabId}" name="cargoArrivalType-{tabId}" class="cargoArrivalType" value="готовый вид" checked>
                            <label for="cargoTypeReady-{tabId}">Готовый вид, дополнительные услуги не требуются</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="cargoTypeBulk-{tabId}" name="cargoArrivalType-{tabId}" class="cargoArrivalType" value="россыпью">
                            <label for="cargoTypeBulk-{tabId}">Россыпью</label>
                        </div>
                    </div>
                </div>
                
                <!-- Блок для варианта "Россыпью" -->
                <div class="cargo-bulk-details hidden">
                    <div class="form-group">
                        <label>Требуется ли маркировка коробов?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="bulkBoxMarkingNo-{tabId}" name="bulkBoxMarking-{tabId}" class="bulkBoxMarking" value="нет" checked>
                                <label for="bulkBoxMarkingNo-{tabId}">Нет</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bulkBoxMarkingYes-{tabId}" name="bulkBoxMarking-{tabId}" class="bulkBoxMarking" value="да">
                                <label for="bulkBoxMarkingYes-{tabId}">Да</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Паллетирование:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="palletizationNo-{tabId}" name="palletization-{tabId}" class="palletization" value="не нужно" checked>
                                <label for="palletizationNo-{tabId}">Не нужно</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="palletizationOnly-{tabId}" name="palletization-{tabId}" class="palletization" value="только паллетирование">
                                <label for="palletizationOnly-{tabId}">Нужно только паллетирование</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="palletizationWithPallet-{tabId}" name="palletization-{tabId}" class="palletization" value="поддон и паллетирование">
                                <label for="palletizationWithPallet-{tabId}">Нужен поддон и паллетирование</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Нужен ли забор вашего груза?</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="needPickupNo-{tabId}" name="needPickup-{tabId}" class="needPickup" value="нет" checked>
                        <label for="needPickupNo-{tabId}">Нет</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="needPickupYes-{tabId}" name="needPickup-{tabId}" class="needPickup" value="да">
                        <label for="needPickupYes-{tabId}">Да</label>
                    </div>
                </div>
                <div id="pickupWarning-{tabId}" class="pickup-warning hidden">
                    <p>Внимание: заборы нашими силами осуществляются не менее, чем ЗА ДЕНЬ до отправки груза на маркетплейс - <strong>заборы день в день НЕ ПРОИЗВОДИМ!</strong></p>
                </div>
            </div>
            
            <div class="pickup-details hidden">
                <div class="form-group">
                    <label for="pickupAddress-{tabId}">Введите адрес забора груза:</label>
                    <textarea id="pickupAddress-{tabId}" class="pickupAddress" rows="3" required disabled></textarea>
                </div>
                
                <div class="form-group">
                    <label>Временной промежуток для забора:</label>
                    <div class="time-range">
                        <select id="pickupTimeFrom-{tabId}" class="pickupTimeFrom" required disabled>
                            <option value="">С</option>
                            <option value="9:00">9:00</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                        </select>
                        <span>до</span>
                        <select id="pickupTimeTo-{tabId}" class="pickupTimeTo" required disabled>
                            <option value="">До</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>

                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contactPhone-{tabId}">Телефон контактного лица:</label>
                    <input type="tel" id="contactPhone-{tabId}" class="contactPhone" placeholder="+7 (___) ___-__-__" required disabled>
                </div>
                
                <div class="form-group">
                    <label for="accessComment-{tabId}">Комментарий к проезду:</label>
                    <textarea id="accessComment-{tabId}" class="accessComment" rows="3" placeholder="Укажите нюансы - есть ли шлагбаум, как проехать, пункт охраны, номер домофона и т.д." disabled></textarea>
                </div>
                
                <div class="form-group">
                    <label>Требуется ли помощь водителя?</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="driverHelpNo-{tabId}" name="driverHelp-{tabId}" class="driverHelp" value="нет" checked disabled>
                            <label for="driverHelpNo-{tabId}">Нет</label>
                        </div>
                        <div class="radio-option">
                            
                            <input type="radio" id="driverHelpYes-{tabId}" name="driverHelp-{tabId}" class="driverHelp" value="да" disabled>
                            <label for="driverHelpYes-{tabId}">Да</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // Константы
        const SPREADSHEET_ID = '1u03UnXYIrPcF6yY87yetvcFvb14HlM6gQrSefMBjMWY';
        const WEBHOOK_URL = 'https://fulfillmentserver.ru/webhook/c997ca37-fee7-4752-aeb1-93a7ab515917';
        const MAX_TABS = 5;
        
        // DOM-элементы
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const tabsContainer = document.getElementById('tabsContainer');
        const tabsNav = document.getElementById('tabs');
        const addTabBtn = document.getElementById('addTabBtn');
        const cargoFormMain = document.getElementById('cargoFormMain');
        const formTemplate = document.getElementById('formTemplate');
        const submitButton = document.getElementById('submitButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const telegramUserInfo = document.getElementById('telegramUserInfo');
        const telegramUserId = document.getElementById('telegramUserId');
        const telegramUserName = document.getElementById('telegramUserName');
        const themeToggle = document.getElementById('themeToggle');
        
        // Хранилище данных
        let tableData = [];
        let tabCounter = 1;
        let activeTabs = ['tab1'];
        let telegramData = null;
        
        // Функция для установки темы
        function setTheme(isDark) {
            if (isDark) {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
            }
            
            // Обновляем позицию маркера при смене темы
            const slider = document.querySelector('.slider');
            if (slider) {
                setTimeout(() => {
                    // Небольшая задержка для корректной анимации
                    slider.style.transition = '.4s';
                }, 50);
            }
        }
        
        // Обработчик переключения темы
        themeToggle.addEventListener('change', function() {
            setTheme(this.checked);
        });
        
        // Получение сегодняшней даты в формате YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Проверка, прошло ли уже 12:00 по МСК
        function isPastNoonMSK() {
            // Создаем текущую дату по местному времени
            const now = new Date();
            
            // Получаем смещение текущего часового пояса от UTC в минутах
            const localOffset = now.getTimezoneOffset();
            
            // Вычисляем московское время (UTC+3)
            const mskOffset = -180; // UTC+3 = -180 минут
            
            // Рассчитываем разницу в минутах между местным и московским временем
            const offsetDiff = localOffset + mskOffset;
            
            // Создаем новую дату с учетом разницы
            const mskTime = new Date(now.getTime() + offsetDiff * 60000);
            
            // Проверяем, больше ли часов, чем 12
            return mskTime.getHours() >= 12;
        }
        
        // Преобразование строки даты в формате DD.MM.YYYY или DD.MM.YY в формат YYYY-MM-DD
        function parseDateString(dateStr) {
            // Разбиваем строку даты
            const parts = dateStr.split('.');
            
            if (parts.length !== 3) {
                console.error('Некорректный формат даты:', dateStr);
                return null;
            }
            
            let day = parts[0];
            let month = parts[1];
            let year = parts[2];
            
            // Проверяем, является ли год двузначным
            if (year.length === 2) {
                // Предполагаем, что годы 00-49 относятся к 2000-2049, а 50-99 к 1950-1999
                year = year < 50 ? '20' + year : '19' + year;
            }
            
            // Убедимся, что день и месяц имеют две цифры
            day = day.padStart(2, '0');
            month = month.padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // Форматирование даты для отображения в формате DD.MM.YYYY
        function formatDateForDisplay(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}.${month}.${year}`;
        }
        
        // Добавление дней к дате
        function addDays(dateStr, days) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Вычитание дней из даты
        function subtractDays(dateStr, days) {
            return addDays(dateStr, -days);
        }
        
        // Проверка, является ли первая дата раньше или равной второй
        function isDateBeforeOrEqual(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1 <= d2;
        }
        
        // Инициализация Telegram WebApp
        function initTelegramApp() {
            // Применяем сохраненную тему или устанавливаем тему на основе Telegram
            const savedTheme = localStorage.getItem('theme');
            let isDarkTheme = false;
            
            // Проверка темы Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                // Определяем, темная ли тема в Telegram
                isDarkTheme = tg.colorScheme === 'dark';
            }
            
            // Применяем сохраненную тему, если она есть
            if (savedTheme) {
                isDarkTheme = savedTheme === 'dark';
            }
            
            // Устанавливаем состояние переключателя
            themeToggle.checked = isDarkTheme;
            
            // Применяем тему
            setTheme(isDarkTheme);
            
            // Расширяем для Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                
                // Расширяем область до полного размера
                tg.expand();
                
                // Получаем данные пользователя
                try {
                    // Парсим данные инициализации
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        telegramData = tg.initDataUnsafe.user;
                        
                        // Отображаем информацию о пользователе
                        telegramUserInfo.classList.remove('hidden');
                        telegramUserId.textContent = telegramData.id || 'Не определен';
                        telegramUserName.textContent = 
                            (telegramData.first_name || '') + 
                            (telegramData.last_name ? ' ' + telegramData.last_name : '');
                    } else {
                        console.warn('Данные пользователя Telegram недоступны');
                        
                        // Фиктивные данные для тестирования вне Telegram
                        telegramData = { id: 'test_user_123', first_name: 'Test', last_name: 'User' };
                        
                        // В режиме тестирования тоже показываем блок с данными
                        telegramUserInfo.classList.remove('hidden');
                        telegramUserId.textContent = telegramData.id + ' (тестовый режим)';
                        telegramUserName.textContent = telegramData.first_name + ' ' + telegramData.last_name;
                    }
                } catch (error) {
                    console.error('Ошибка при получении данных Telegram:', error);
                    
                    // Фиктивные данные для продолжения работы
                    telegramData = { id: 'error_user', first_name: 'Error', last_name: 'User' };
                    
                    telegramUserInfo.classList.remove('hidden');
                    telegramUserId.textContent = 'Не удалось определить';
                    telegramUserName.textContent = 'Не удалось определить';
                }
                
                // Настраиваем кнопку отправки в соответствии с темой Telegram
                if (tg.MainButton) {
                    // Настраиваем и показываем Главную кнопку Telegram
                    tg.MainButton.setText('Отправить заявку');
                    tg.MainButton.onClick(submitForm);
                    tg.MainButton.show();
                    
                    // Скрываем нашу стандартную кнопку
                    submitButton.style.display = 'none';
                }
            } else {
                console.log('Приложение запущено вне Telegram WebApp');
                
                // Фиктивные данные для тестирования вне Telegram
                telegramData = { id: 'browser_user_456', first_name: 'Browser', last_name: 'User' };
                
                // В режиме тестирования тоже показываем блок с данными
                telegramUserInfo.classList.remove('hidden');
                telegramUserId.textContent = telegramData.id + ' (браузер)';
                telegramUserName.textContent = telegramData.first_name + ' ' + telegramData.last_name;
                
                // В браузере показываем стандартную кнопку
                submitButton.style.display = 'block';
            }
        }
        
        // Загрузка данных из Google Sheets
        async function loadGoogleSheet() {
            try {
                // Используем публичный API для получения данных из опубликованной таблицы
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=Расписание`;
                console.log('Загрузка данных из URL:', url);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Не удалось загрузить данные из таблицы. Проверьте доступ.');
                }
                
                const csvText = await response.text();
                console.log('Полученные данные CSV:', csvText);
                
                // Парсинг CSV
                const rows = csvText.split('\n').map(row => {
                    // Разбиваем строку на ячейки, учитывая возможные кавычки
                    const cells = [];
                    let inQuotes = false;
                    let currentCell = '';
                    
                    for (let i = 0; i < row.length; i++) {
                        const char = row[i];
                        
                        if (char === '"' && (i === 0 || row[i-1] !== '\\')) {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            cells.push(currentCell.replace(/""/g, '"'));
                            currentCell = '';
                        } else {
                            currentCell += char;
                        }
                    }
                    cells.push(currentCell.replace(/""/g, '"').replace(/^"|"$/g, ''));
                    
                    return cells;
                });
                
                console.log('Распарсенные строки:', rows);
                
                // Первая строка - заголовки
                const headers = rows[0];
                console.log('Заголовки таблицы:', headers);
                
                // Находим индексы нужных столбцов
                const colIndices = {
                    branch: headers.findIndex(h => h.includes('илиал')),
                    marketplace: headers.findIndex(h => h.includes('аркетплейс')),
                    city: headers.findIndex(h => h.includes('ород')),
                    warehouse: headers.findIndex(h => h.includes('клад')),
                    address: headers.findIndex(h => h.includes('дрес')),
                    leadDays: 6, // Новый столбец G с количеством дней для доставки
                    date1: 7,    // Столбец H с датой 1
                    date2: 8,    // Столбец I с датой 2
                    date3: 9,    // Столбец J с датой 3
                    date4: 10,   // Столбец K с датой 4
                    date5: 11,   // Столбец L с датой 5
                    date6: 12,   // Столбец M с датой 6
                    date7: 13,   // Столбец N с датой 7
                    date8: 14,   // Столбец O с датой 8
                    date9: 15,   // Столбец P с датой 9
                    date10: 16,  // Столбец Q с датой 10
                    date11: 17,  // Столбец R с датой 11
                    date12: 18   // Столбец S с датой 12
                };
                
                console.log('Индексы столбцов:', colIndices);
                
                // Преобразуем данные в удобный формат
                tableData = rows.slice(1).map(row => ({
                    branch: row[colIndices.branch],
                    marketplace: row[colIndices.marketplace],
                    city: row[colIndices.city],
                    warehouse: row[colIndices.warehouse],
                    address: row[colIndices.address],
                    leadDays: parseInt(row[colIndices.leadDays]) || 0,
                    date1: row[colIndices.date1],
                    date2: row[colIndices.date2],
                    date3: row[colIndices.date3],
                    date4: row[colIndices.date4],
                    date5: row[colIndices.date5],
                    date6: row[colIndices.date6],
                    date7: row[colIndices.date7],
                    date8: row[colIndices.date8],
                    date9: row[colIndices.date9],
                    date10: row[colIndices.date10],
                    date11: row[colIndices.date11],
                    date12: row[colIndices.date12]
                })).filter(row => row.branch && row.marketplace && row.city && row.warehouse); // Фильтруем пустые строки
                
                console.log('Обработанные данные:', tableData);
                
                // Проверяем наличие дат в данных
                const hasDates = tableData.some(row => 
                    row.date1.trim() || row.date2.trim() || row.date3.trim() || 
                    row.date4.trim() || row.date5.trim() || row.date6.trim() ||
                    row.date7.trim() || row.date8.trim() || row.date9.trim() ||
                    row.date10.trim() || row.date11.trim() || row.date12.trim()
                );
                
                if (!hasDates) {
                    console.warn('В таблице нет записей с заполненными датами');
                    errorDiv.classList.remove('hidden');
                    errorDiv.textContent = 'В таблице нет записей с заполненными датами. Пожалуйста, проверьте данные в таблице.';
                    return;
                }
                
                // Инициализация первой вкладки
                initTab('tab1');
                
                // Показываем форму и скрываем индикатор загрузки
                loadingDiv.style.display = 'none';
                tabsContainer.classList.remove('hidden');
                
                // Показываем Главную кнопку Telegram, если это Telegram WebApp
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                    window.Telegram.WebApp.MainButton.show();
                }
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                loadingDiv.style.display = 'none';
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = `Ошибка загрузки данных: ${error.message}`;
            }
        }
        
        // Фильтрация данных с учетом наличия дат
        function filterDataWithDates(data) {
            return data.filter(item => 
                item.date1.trim() || item.date2.trim() || item.date3.trim() || 
                item.date4.trim() || item.date5.trim() || item.date6.trim() ||
                item.date7.trim() || item.date8.trim() || item.date9.trim() ||
                item.date10.trim() || item.date11.trim() || item.date12.trim()
            );
        }
        
        // Инициализация вкладки
        function initTab(tabId) {
            const tabContent = document.getElementById(tabId);
            
            // Если содержимое вкладки еще не создано
            if (!tabContent.querySelector('.form-content')) {
                // Клонируем шаблон формы
                const content = formTemplate.content.cloneNode(true);
                
                // Заменяем плейсхолдер {tabId} на реальный id вкладки во всех элементах
                const tabIdNum = tabId.replace('tab', '');
                content.querySelectorAll('[id$="-{tabId}"]').forEach(el => {
                    el.id = el.id.replace('{tabId}', tabIdNum);
                });
                content.querySelectorAll('[name$="-{tabId}"]').forEach(el => {
                    el.name = el.name.replace('{tabId}', tabIdNum);
                });
                content.querySelectorAll('[for$="-{tabId}"]').forEach(el => {
                    el.setAttribute('for', el.getAttribute('for').replace('{tabId}', tabIdNum));
                });
                
                // Добавляем содержимое в вкладку
                tabContent.appendChild(content);
                
                // Заполняем селект филиалов
                populateBranches(tabIdNum);
                
                // Устанавливаем обработчики событий
                setEventHandlers(tabIdNum);
                
                // Добавляем кнопку закрытия для всех вкладок, кроме первой
                if (tabIdNum > 1) {
                    const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                    if (tabElement) {
                        // Добавляем кнопку закрытия
                        const closeButton = document.createElement('span');
                        closeButton.className = 'tab-close';
                        closeButton.innerHTML = '×';
                        closeButton.title = 'Закрыть вкладку';
                        closeButton.onclick = function(e) {
                            e.stopPropagation(); // Предотвращаем переключение на вкладку при клике на крестик
                            closeTab(tabId);
                        };
                        tabElement.appendChild(closeButton);
                    }
                }
            }
        }
        
        // Перенумерация вкладок
        function renumberTabs() {
            // Сортируем вкладки по порядку DOM
            const tabElements = Array.from(document.querySelectorAll('.tab:not(#addTabBtn)'));
            
            // Обновляем текст вкладок
            tabElements.forEach((tabElement, index) => {
                const tabNumber = index + 1;
                tabElement.textContent = `Заказ ${tabNumber}`;
                
                // Если это не первая вкладка, добавляем кнопку закрытия
                if (tabNumber > 1) {
                    const closeButton = document.createElement('span');
                    closeButton.className = 'tab-close';
                    closeButton.innerHTML = '×';
                    closeButton.title = 'Закрыть вкладку';
                    const tabId = tabElement.dataset.tabId;
                    closeButton.onclick = function(e) {
                        e.stopPropagation();
                        closeTab(tabId);
                    };
                    tabElement.appendChild(closeButton);
                }
            });
        }
        
        // Заполнение селекта филиалов
        function populateBranches(tabIdNum) {
            const branchSelect = document.getElementById(`branch-${tabIdNum}`);
            
            // Очищаем селект
            branchSelect.innerHTML = '<option value="">Выберите филиал</option>';
            
            // Фильтруем данные по наличию дат
            const validData = filterDataWithDates(tableData);
            
            if (validData.length === 0) {
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = 'В таблице нет записей с заполненными датами.';
                return;
            }
            
            // Получаем уникальные филиалы
            const branches = [...new Set(validData.map(item => item.branch))].filter(Boolean);
            
            // Заполняем селект филиалов
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                branchSelect.appendChild(option);
            });
        }
        
        // Установка обработчиков событий для элементов вкладки
        function setEventHandlers(tabIdNum) {
            // Селекты для основных полей
            const branchSelect = document.getElementById(`branch-${tabIdNum}`);
            const marketplaceSelect = document.getElementById(`marketplace-${tabIdNum}`);
            const citySelect = document.getElementById(`city-${tabIdNum}`);
            const warehouseSelect = document.getElementById(`warehouse-${tabIdNum}`);
            const marketplaceShipmentDateSelect = document.getElementById(`marketplaceShipmentDate-${tabIdNum}`);
            const ncgShipmentDateSelect = document.getElementById(`ncgShipmentDate-${tabIdNum}`);
            const addressDisplay = document.getElementById(`address-${tabIdNum}`);
            
            // Радио-кнопки для типа упаковки и соответствующие блоки
            const packageTypeRadios = document.querySelectorAll(`[name="packageType-${tabIdNum}"]`);
            const packageBoxDetails = document.querySelector(`#tab${tabIdNum} .package-box-details`);
            const packagePalletDetails = document.querySelector(`#tab${tabIdNum} .package-pallet-details`);
            
            // Радио-кнопки для вида прибытия груза и дополнительные поля
            const cargoArrivalTypeRadios = document.querySelectorAll(`[name="cargoArrivalType-${tabIdNum}"]`);
            const cargoBulkDetails = document.querySelector(`#tab${tabIdNum} .cargo-bulk-details`);
            
            // Радиокнопки и поля для забора груза
            const needPickupRadios = document.querySelectorAll(`[name="needPickup-${tabIdNum}"]`);
            const pickupDetails = document.querySelector(`#tab${tabIdNum} .pickup-details`);
            const pickupAddress = document.getElementById(`pickupAddress-${tabIdNum}`);
            const pickupTimeFrom = document.getElementById(`pickupTimeFrom-${tabIdNum}`);
            const pickupTimeTo = document.getElementById(`pickupTimeTo-${tabIdNum}`);
            const contactPhone = document.getElementById(`contactPhone-${tabIdNum}`);
            const accessComment = document.getElementById(`accessComment-${tabIdNum}`);
            const cargoWeight = document.getElementById(`cargoWeight-${tabIdNum}`);
            const driverHelpRadios = document.querySelectorAll(`[name="driverHelp-${tabIdNum}"]`);
            
            // Общие вопросы для всех типов упаковки
            const packingListRadios = document.querySelectorAll(`[name="packingList-${tabIdNum}"]`);
            const barcodeCheckRadios = document.querySelectorAll(`[name="barcodeCheck-${tabIdNum}"]`);
            
            // Обработчик выбора филиала
            branchSelect.addEventListener('change', function() {
                // Сбрасываем последующие селекты
                resetSelect(marketplaceSelect, 'Выберите маркетплейс');
                resetSelect(citySelect, 'Сначала выберите маркетплейс');
                resetSelect(warehouseSelect, 'Сначала выберите город');
                resetSelect(marketplaceShipmentDateSelect, 'Сначала выберите склад');
                resetSelect(ncgShipmentDateSelect, 'Сначала выберите дату отгрузки на маркетплейс');
                addressDisplay.textContent = 'Адрес появится после выбора склада';
                
                const selectedBranch = this.value;
                
                if (!selectedBranch) {
                    marketplaceSelect.disabled = true;
                    return;
                }
                
                // Фильтруем маркетплейсы для выбранного филиала
                const validData = filterDataWithDates(tableData);
                const marketplaces = [...new Set(
                    validData
                        .filter(item => item.branch === selectedBranch)
                        .map(item => item.marketplace)
                )].filter(Boolean);
                
                // Заполняем селект маркетплейсов
                marketplaces.forEach(marketplace => {
                    const option = document.createElement('option');
                    option.value = marketplace;
                    option.textContent = marketplace;
                    marketplaceSelect.appendChild(option);
                });
                
                // Активируем селект маркетплейсов
                marketplaceSelect.disabled = false;
            });
            
            // Обработчик выбора маркетплейса
            marketplaceSelect.addEventListener('change', function() {
                // Сбрасываем последующие селекты
                resetSelect(citySelect, 'Выберите город');
                resetSelect(warehouseSelect, 'Сначала выберите город');
                resetSelect(marketplaceShipmentDateSelect, 'Сначала выберите склад');
                resetSelect(ncgShipmentDateSelect, 'Сначала выберите дату отгрузки на маркетплейс');
                addressDisplay.textContent = 'Адрес появится после выбора склада';
                
                const selectedBranch = branchSelect.value;
                const selectedMarketplace = this.value;
                
                if (!selectedMarketplace) {
                    citySelect.disabled = true;
                    return;
                }
                
                // Фильтруем города для выбранного филиала и маркетплейса
                const validData = filterDataWithDates(tableData);
                const cities = [...new Set(
                    validData
                        .filter(item => 
                            item.branch === selectedBranch && 
                            item.marketplace === selectedMarketplace
                        )
                        .map(item => item.city)
                )].filter(Boolean);
                
                // Заполняем селект городов
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
                
                // Активируем селект городов
                citySelect.disabled = false;
            });
            
            // Обработчик выбора города
            citySelect.addEventListener('change', function() {
                // Сбрасываем последующие селекты
                resetSelect(warehouseSelect, 'Выберите склад');
                resetSelect(marketplaceShipmentDateSelect, 'Сначала выберите склад');
                resetSelect(ncgShipmentDateSelect, 'Сначала выберите дату отгрузки на маркетплейс');
                addressDisplay.textContent = 'Адрес появится после выбора склада';
                
                const selectedBranch = branchSelect.value;
                const selectedMarketplace = marketplaceSelect.value;
                const selectedCity = this.value;
                
                if (!selectedCity) {
                    warehouseSelect.disabled = true;
                    return;
                }
                
                // Фильтруем склады для выбранного филиала, маркетплейса и города
                const validData = filterDataWithDates(tableData);
                const warehouses = [...new Set(
                    validData
                        .filter(item => 
                            item.branch === selectedBranch && 
                            item.marketplace === selectedMarketplace && 
                            item.city === selectedCity
                        )
                        .map(item => item.warehouse)
                )].filter(Boolean);
                
                // Заполняем селект складов
                warehouses.forEach(warehouse => {
                    const option = document.createElement('option');
                    option.value = warehouse;
                    option.textContent = warehouse;
                    warehouseSelect.appendChild(option);
                });
                
                // Активируем селект складов
                warehouseSelect.disabled = false;
            });
            
            // Обработчик выбора склада - добавляем проверку доступных дат
            warehouseSelect.addEventListener('change', function() {
                // Сбрасываем селект даты
                resetSelect(marketplaceShipmentDateSelect, 'Выберите дату отгрузки на маркетплейс');
                resetSelect(ncgShipmentDateSelect, 'Сначала выберите дату отгрузки на маркетплейс');
                
                const selectedBranch = branchSelect.value;
                const selectedMarketplace = marketplaceSelect.value;
                const selectedCity = citySelect.value;
                const selectedWarehouse = this.value;
                
                if (!selectedWarehouse) {
                    marketplaceShipmentDateSelect.disabled = true;
                    addressDisplay.textContent = 'Адрес появится после выбора склада';
                    return;
                }
                
                // Ищем подходящую запись в данных
                const validData = filterDataWithDates(tableData);
                const selectedItem = validData.find(item => 
                    item.branch === selectedBranch && 
                    item.marketplace === selectedMarketplace && 
                    item.city === selectedCity &&
                    item.warehouse === selectedWarehouse
                );
                
                if (!selectedItem) {
                    addressDisplay.textContent = 'Не найдены данные для выбранных параметров';
                    return;
                }
                
                // Отображаем адрес склада
                addressDisplay.textContent = selectedItem.address || 'Адрес не указан';
                
                // Получаем количество дней для доставки (leadDays)
                const leadDays = selectedItem.leadDays || 0;
                
                // Получаем текущую дату и проверяем время
                const today = getTodayDate();
                const isPastNoon = isPastNoonMSK();
                
                // Добавляем доступные даты отгрузки на маркетплейс
                const dates = [];
                
                // Проверяем каждую дату на доступность с учетом leadDays
                // Отладочная информация
                console.log("Количество дней для доставки:", leadDays);
                console.log("Текущая дата:", today);
                console.log("Прошло 12:00 МСК:", isPastNoon);
                
                // Проверяем все даты до date12
                for (let i = 1; i <= 12; i++) {
                    const dateCol = `date${i}`;
                    const dateValue = selectedItem[dateCol];
                    if (dateValue && dateValue.trim() !== '') {
                        const date = parseDateString(dateValue);
                        if (date && date >= today) {
                            dates.push({ value: dateCol, text: formatDateForDisplay(date) });
                        }
                    }
                }
                
                // Если нет доступных дат, показываем сообщение
                if (dates.length === 0) {
                    marketplaceShipmentDateSelect.innerHTML = '';
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Нет доступных дат отгрузки для этого склада';
                    marketplaceShipmentDateSelect.appendChild(option);
                    marketplaceShipmentDateSelect.disabled = true;
                    return;
                }
                
                // Заполняем селект дат отгрузки на маркетплейс
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date.value;
                    option.textContent = date.text;
                    option.dataset.rawDate = date.text; // Сохраняем оригинальную дату для расчетов
                    marketplaceShipmentDateSelect.appendChild(option);
                });
                
                // Активируем селект дат отгрузки на маркетплейс
                marketplaceShipmentDateSelect.disabled = false;
            });
            
            // Обработчик выбора даты отгрузки на маркетплейс
            marketplaceShipmentDateSelect.addEventListener('change', function() {
                const selectedDate = this.value;
                if (!selectedDate) {
                    resetSelect(ncgShipmentDateSelect, 'Сначала выберите дату отгрузки на маркетплейс');
                    ncgShipmentDateSelect.disabled = true;
                    return;
                }
                
                // Получаем текст выбранной опции (для отображения)
                const selectedOption = this.options[this.selectedIndex];
                const marketplaceShipmentDateText = selectedOption.textContent;
                
                // Очищаем и заполняем селект для даты отгрузки на склад NCG
                ncgShipmentDateSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Выберите дату отгрузки к нам на склад NCG';
                ncgShipmentDateSelect.appendChild(defaultOption);
                
                // Получаем выбранные значения из селектов
                const selectedMarketplace = marketplaceSelect.value;
                const selectedCity = citySelect.value;
                const selectedWarehouse = warehouseSelect.value;
                
                // Поиск соответствующего элемента в tableData
                const selectedItem = tableData.find(item => 
                    item.marketplace === selectedMarketplace && 
                    item.city === selectedCity &&
                    item.warehouse === selectedWarehouse
                );
                
                if (!selectedItem) {
                    return;
                }
                
                // Получаем количество дней для доставки (leadDays)
                const leadDays = selectedItem.leadDays || 0;
                
                // Преобразуем дату из формата DD.MM.YYYY или DD.MM.YY в формат YYYY-MM-DD
                const marketplaceShipmentDateISO = parseDateString(marketplaceShipmentDateText);
                
                // Вычисляем крайнюю дату отгрузки на склад NCG (маркетплейс - leadDays)
                const latestNcgShipmentDate = subtractDays(marketplaceShipmentDateISO, leadDays);
                
                // Получаем текущую дату
                const today = getTodayDate();
                const isPastNoon = isPastNoonMSK();
                
                // Создаем список доступных дат для отгрузки на склад NCG
                const ncgShipmentDates = [];
                
                // Определяем стартовую дату (сегодня)
                let currentDate = new Date(today);
                
                // Определяем конечную дату (крайняя дата отгрузки)
                const lastDate = new Date(latestNcgShipmentDate);
                
                // Проверка для случая, когда крайняя дата совпадает с сегодняшней и уже после 12:00
                if (latestNcgShipmentDate === today && isPastNoon) {
                    ncgShipmentDateSelect.innerHTML = '';
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Время отгрузки на сегодня уже истекло (после 12:00 МСК)';
                    ncgShipmentDateSelect.appendChild(option);
                    ncgShipmentDateSelect.disabled = true;
                    return;
                }
                
                // Если крайняя дата раньше сегодняшней, отображаем сообщение о невозможности доставки
                if (lastDate < currentDate) {
                    ncgShipmentDateSelect.innerHTML = '';
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Крайний срок отгрузки уже прошел';
                    ncgShipmentDateSelect.appendChild(option);
                    ncgShipmentDateSelect.disabled = true;
                    return;
                }
                
                // Добавляем все даты от сегодня до крайней даты отгрузки на склад NCG
                while (currentDate <= lastDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // Проверяем, не является ли дата воскресеньем (0 - воскресенье, 6 - суббота)
                    const dayOfWeek = currentDate.getDay();
                    
                    // Пропускаем воскресенья
                    if (dayOfWeek !== 0) {
                    // Если это сегодняшняя дата и крайняя дата, добавляем пометку "до 12:00 МСК"
                    if (dateStr === today && dateStr === latestNcgShipmentDate) {
                        ncgShipmentDates.push({
                            value: dateStr,
                            text: formatDateForDisplay(dateStr) + " (до 12:00 МСК)"
                        });
                    } else {
                        ncgShipmentDates.push({
                            value: dateStr,
                            text: formatDateForDisplay(dateStr)
                        });
                        }
                    }
                    
                    // Переходим на следующий день
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Заполняем селект дат отгрузки на склад NCG
                ncgShipmentDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date.value;
                    option.textContent = date.text;
                    ncgShipmentDateSelect.appendChild(option);
                });
                
                // Активируем селект дат отгрузки на склад NCG
                ncgShipmentDateSelect.disabled = false;
                
                // Если выбрана дата отгрузки на склад NCG, проверяем совпадение дат
                if (ncgShipmentDateSelect.selectedIndex > 0) {
                    const changeEvent = new Event('change');
                    ncgShipmentDateSelect.dispatchEvent(changeEvent);
                }
            });
            
            // Добавляем обработчик выбора даты отгрузки на склад NCG
            ncgShipmentDateSelect.addEventListener('change', function() {
                const selectedDate = this.value;
                if (!selectedDate) {
                    return;
                }
                
                // Получаем текст выбранной даты для склада NCG (фактическая дата)
                const ncgDateText = this.options[this.selectedIndex].textContent.split(' ')[0]; // Берем только дату, без времени
                
                // Получаем текст выбранной даты для маркетплейса (если выбрана)
                const marketplaceSelect = marketplaceShipmentDateSelect;
                let marketplaceDateText = '';
                if (marketplaceSelect.selectedIndex > 0) {
                    marketplaceDateText = marketplaceSelect.options[marketplaceSelect.selectedIndex].textContent.split(' ')[0];
                }
                
                // Проверяем, совпадают ли даты
                const datesMatch = marketplaceDateText && ncgDateText && marketplaceDateText === ncgDateText;
                
                // Проверяем совпадение дат и показываем предупреждение всегда
                const ncgDateWarning = document.getElementById(`ncg-date-warning-${tabIdNum}`);
                if (ncgDateWarning) {
                    ncgDateWarning.style.display = 'block';
                }
                
                // Если даты совпадают, блокируем опцию "да" для забора груза
                const needPickupYes = document.getElementById(`needPickupYes-${tabIdNum}`);
                const needPickupNo = document.getElementById(`needPickupNo-${tabIdNum}`);
                
                if (datesMatch) {
                    // Блокируем опцию "да" и выбираем "нет"
                    needPickupYes.disabled = true;
                    needPickupNo.checked = true;
                    
                    // Имитируем событие change, чтобы скрыть детали забора груза
                    const changeEvent = new Event('change');
                    needPickupNo.dispatchEvent(changeEvent);
                    
                    // Добавим предупреждение о невозможности забора
                    let pickupWarning = document.getElementById(`sameday-pickup-warning-${tabIdNum}`);
                    if (!pickupWarning) {
                        pickupWarning = document.createElement('div');
                        pickupWarning.id = `sameday-pickup-warning-${tabIdNum}`;
                        pickupWarning.className = 'warning-message';
                        const needPickupGroup = needPickupYes.closest('.form-group');
                        needPickupGroup.appendChild(pickupWarning);
                    }
                    pickupWarning.style.display = 'block';
                    pickupWarning.innerHTML = 'Забор груза недоступен в день отгрузки на маркетплейс<br><br><strong>Внимание:</strong> заборы нашими силами осуществляются не менее, чем ЗА ДЕНЬ до отправки груза на маркетплейс - заборы день в день НЕ ПРОИЗВОДИМ!';
                } else {
                    // Проверяем, не является ли выбранная дата сегодняшней
                    const today = getTodayDate();
                    const todayFormatted = formatDateForDisplay(today);
                    const isToday = ncgDateText === todayFormatted;
                    
                    if (isToday) {
                        // Если сегодня, также блокируем
                        needPickupYes.disabled = true;
                        needPickupNo.checked = true;
                        
                        // Имитируем событие change
                        const changeEvent = new Event('change');
                        needPickupNo.dispatchEvent(changeEvent);
                        
                        // Добавим предупреждение о сегодняшней дате
                        let pickupWarning = document.getElementById(`sameday-pickup-warning-${tabIdNum}`);
                        if (!pickupWarning) {
                            pickupWarning = document.createElement('div');
                            pickupWarning.id = `sameday-pickup-warning-${tabIdNum}`;
                            pickupWarning.className = 'warning-message';
                            const needPickupGroup = needPickupYes.closest('.form-group');
                            needPickupGroup.appendChild(pickupWarning);
                        }
                        pickupWarning.style.display = 'block';
                        pickupWarning.textContent = 'Забор груза на сегодня недоступен';
                    } else {
                        // Разблокируем опцию "да"
                        needPickupYes.disabled = false;
                        
                        // Скрываем предупреждение, если оно есть
                        const pickupWarning = document.getElementById(`sameday-pickup-warning-${tabIdNum}`);
                        if (pickupWarning) {
                            pickupWarning.style.display = 'none';
                        }
                    }
                }
            });
            
            // Обновляем проверку совпадения дат при изменении даты отгрузки на маркетплейс
            marketplaceShipmentDateSelect.addEventListener('change', function() {
                // Если выбрана дата отгрузки на склад NCG, проверяем совпадение
                if (ncgShipmentDateSelect.selectedIndex > 0) {
                    // Получаем текст выбранной даты для маркетплейса
                    const marketplaceDateText = this.options[this.selectedIndex].textContent.split(' ')[0];
                    // Получаем текст выбранной даты для склада NCG
                    const ncgDateText = ncgShipmentDateSelect.options[ncgShipmentDateSelect.selectedIndex].textContent.split(' ')[0];
                    
                    // Проверяем совпадение дат и показываем/скрываем предупреждение
                    const datesMatch = marketplaceDateText && ncgDateText && marketplaceDateText === ncgDateText;
                    const ncgDateWarning = document.getElementById(`ncg-date-warning-${tabIdNum}`);
                    
                    if (datesMatch && ncgDateWarning) {
                        ncgDateWarning.style.display = 'block';
                    } else if (ncgDateWarning) {
                        ncgDateWarning.style.display = 'none';
                    }
                    
                    // Имитируем изменение даты NCG для проверки совпадения и блокировки забора
                    const changeEvent = new Event('change');
                    ncgShipmentDateSelect.dispatchEvent(changeEvent);
                }
            });
            
            // Обработчик выбора типа упаковки
            packageTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Скрываем все связанные блоки
                    packageBoxDetails.classList.add('hidden');
                    packagePalletDetails.classList.add('hidden');
                    
                    // Показываем/скрываем поле количества коробов
                    const boxCountField = document.querySelector(`#tab${tabIdNum} .box-count-field`);
                    if (this.value === "паллета" || this.value === "монопаллета") {
                        boxCountField.classList.remove('hidden');
                        document.getElementById(`boxCount-${tabIdNum}`).required = true;
                    } else {
                        boxCountField.classList.add('hidden');
                        document.getElementById(`boxCount-${tabIdNum}`).required = false;
                    }
                    
                    // Показываем блок в зависимости от выбранного типа
                    if (this.value === "короб") {
                        packageBoxDetails.classList.remove('hidden');
                    } else if (this.value === "паллета" || this.value === "монопаллета") {
                        packagePalletDetails.classList.remove('hidden');
                    }
                });
            });
            
            // Обработчик выбора опции "В каком виде груз прибудет"
            cargoArrivalTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === "россыпью") {
                        cargoBulkDetails.classList.remove('hidden');
                    } else {
                        cargoBulkDetails.classList.add('hidden');
                    }
                });
            });
            
            // Обработчик выбора опции "Нужен ли забор груза"
            needPickupRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const pickupWarning = document.getElementById(`pickupWarning-${tabIdNum}`);
                    
                    if (this.value === "да") {
                        pickupDetails.classList.remove('hidden');
                        pickupAddress.disabled = false;
                        pickupTimeFrom.disabled = false;
                        pickupTimeTo.disabled = false;
                        contactPhone.disabled = false;
                        accessComment.disabled = false;
                        driverHelpRadios.forEach(radio => radio.disabled = false);
                        pickupWarning.classList.remove('hidden');
                        
                        pickupAddress.required = true;
                        pickupTimeFrom.required = true;
                        pickupTimeTo.required = true;
                        contactPhone.required = true;
                    } else {
                        pickupDetails.classList.add('hidden');
                        pickupAddress.disabled = true;
                        pickupTimeFrom.disabled = true;
                        pickupTimeTo.disabled = true;
                        contactPhone.disabled = true;
                        accessComment.disabled = true;
                        driverHelpRadios.forEach(radio => radio.disabled = true);
                        pickupWarning.classList.add('hidden');
                        
                        pickupAddress.required = false;
                        pickupTimeFrom.required = false;
                        pickupTimeTo.required = false;
                        contactPhone.required = false;
                    }
                });
            });
            
           // Простая обработка телефона без автоформатирования
contactPhone.addEventListener('input', function(e) {
    // Удаляем все нецифровые символы кроме + в начале
    let value = this.value;
    
    // Если строка начинается с +, сохраняем его
    if (value.startsWith('+')) {
        // Удаляем все нецифровые символы кроме первого +
        value = '+' + value.substring(1).replace(/[^\d]/g, '');
    } else {
        // Удаляем все нецифровые символы
        value = value.replace(/[^\d]/g, '');
        
        // Если есть цифры, добавляем +
        if (value.length > 0) {
            value = '+' + value;
        }
    }
    
    // Ограничиваем длину номера
    if (value.length > 16) { // +15 цифр максимум
        value = value.substring(0, 16);
    }
    
    this.value = value;
});
            
            // Обработчик изменения времени "с"
            pickupTimeFrom.addEventListener('change', function() {
                // Получаем выбранное время "с"
                const fromTime = this.value;
                
                if (!fromTime) {
                    return;
                }
                
                // Сбрасываем селект времени "до"
                resetSelect(pickupTimeTo, 'До');
                
                // Получаем часы из времени "с"
                const fromHour = parseInt(fromTime.split(':')[0]);
                
                // Добавляем опции времени "до", начиная с часа после времени "с"
                for (let hour = fromHour + 1; hour <= 19; hour++) {
                    const timeStr = `${hour}:00`;
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = timeStr;
                    pickupTimeTo.appendChild(option);
                }
                
                // Активируем селект времени "до"
                pickupTimeTo.disabled = false;
            });
        }
        
        // Функция для сброса селекта
        function resetSelect(select, placeholderText) {
            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = placeholderText;
            select.appendChild(placeholder);
            select.disabled = true;
        }
        
        // Добавление новой вкладки
        function addTab() {
            if (activeTabs.length >= MAX_TABS) {
                alert(`Достигнуто максимальное количество заказов (${MAX_TABS})`);
                return;
            }
            
            // Новый номер вкладки равен количеству активных вкладок + 1
            const newTabNum = activeTabs.length + 1;
            const newTabId = `tab${newTabNum}`;
            
            // Добавляем новый ID в список активных вкладок
            activeTabs.push(newTabId);
            
            // Создаем навигационную кнопку вкладки
            const tabButton = document.createElement('div');
            tabButton.className = 'tab';
            tabButton.dataset.tabId = newTabId;
            tabButton.textContent = `Заказ ${newTabNum}`;
            tabsNav.insertBefore(tabButton, addTabBtn);
            
            // Создаем контент вкладки
            const tabContent = document.createElement('div');
            tabContent.id = newTabId;
            tabContent.className = 'tab-content';
            cargoFormMain.insertBefore(tabContent, submitButton);
            
            // Инициализируем новую вкладку
            initTab(newTabId);
            
            // Переключаемся на новую вкладку
            switchTab(newTabId);
        }
        
        // Закрытие вкладки
        function closeTab(tabId) {
            // Нельзя закрыть первую вкладку
            if (tabId === 'tab1') {
                alert('Нельзя закрыть первую вкладку');
                return;
            }
            
            // Проверяем, есть ли такая вкладка
            const tabIndex = activeTabs.indexOf(tabId);
            if (tabIndex === -1) {
                return;
            }
            
            // Удаляем вкладку из массива активных вкладок
            activeTabs.splice(tabIndex, 1);
            
            // Удаляем элемент навигации
            const tabButton = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
            if (tabButton) {
                tabButton.remove();
            }
            
            // Удаляем содержимое вкладки
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.remove();
            }
            
            // Если закрытая вкладка была активной, переключаемся на первую
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab || activeTab.dataset.tabId === tabId) {
                switchTab(activeTabs[0]);
            }
            
            // Перенумеруем вкладки
            renumberTabs();
        }
        
        // Переключение между вкладками
        function switchTab(tabId) {
            // Деактивируем все вкладки
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Активируем выбранную вкладку
            document.querySelector(`.tab[data-tab-id="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // Сбор данных формы
        function collectFormData() {
            // Объект для хранения данных формы
            const formData = {
                telegramUserId: telegramData ? telegramData.id : 'unknown',
                telegramUserName: telegramData ? 
                    (telegramData.first_name || '') + (telegramData.last_name ? ' ' + telegramData.last_name : '') : 
                    'unknown',
                orders: {}
            };
            
            // Собираем данные по всем активным вкладкам
            activeTabs.forEach((tabId, index) => {
                // Используем индекс + 1 как номер заказа для удобства
                const orderNumber = index + 1;
                const tabIdNum = tabId.replace('tab', '');
                const tabFormData = getTabFormData(tabIdNum);
                
                // Сохраняем данные с ключом "Заказ N"
                formData.orders[`Заказ ${orderNumber}`] = tabFormData;
            });
            
            return formData;
        }
        
        // Получение данных формы с вкладки
        function getTabFormData(tabIdNum) {
            // Получаем значения селекторов
            const branch = document.getElementById(`branch-${tabIdNum}`).value;
            const marketplace = document.getElementById(`marketplace-${tabIdNum}`).value;
            const city = document.getElementById(`city-${tabIdNum}`).value;
            const warehouse = document.getElementById(`warehouse-${tabIdNum}`).value;
            
            // Преобразуем значения в числовые коды
            const branchCode = branch === "Склад Москва" ? 105 : branch === "Склад Питер" ? 107 : 0;
            
            const marketplaceCodes = {
                "Wildberries": 285,
                "Ozon": 287,
                "Yandex": 289
            };
            const marketplaceCode = marketplaceCodes[marketplace] || 0;
            
            const cityCodes = {
                "Москва":175,
                "Тула":177,
                "СПб":179,
                "Казань":181,
                "Невинномысск":183,
                "Краснодар":185,
                "Екатеринбург":187,
                "Псков":189,
                "Набережные Челны":191,
                "Самовывоз":193,
                "Рязань":195,
                "Вологда":197,
                "Котовск":199,
                "Волгоград":201,
                "Калуга":565,
                "Владимир":567
            };
            const cityCode = cityCodes[city] || 0;
            
            const warehouseCodes = {
                "Коледино":203,
                "Электросталь":205,
                "Электросталь 2(пят)":207,
                "Казань":209,
                "Краснодар":211,
                "Екатеринбург (П - Перспективный)":213,
                "Екатеринбург (И - Испытателей)":215,
                "Невинномысск":217,
                "Тула":219,
                "Подольск (1 - Поливановская 9с5)":221,
                "Подольск (3 - Поливановская 9с3)":223,
                "Чехов 2 (Промышленная зона Новоселки, вл. 11 стр 7)":225,
                "Бугры":227,
                "РФЦ (ПетроСлавянка)":229,
                "Шушары":231,
                "Уткина Заводь":233,
                "Чехов-1 (Промышленная зона Новоселки, вл. 11 стр 2)":235,
                "Троицкий (Я.Маркет, СПб)":237,
                "Псков СЦ":239,
                "Набережные Челны СЦ":241,
                "Обухово 2":243,
                "Парголово":245,
                "ЯМ Софьино":247,
                "Самовывоз":249,
                "Гривно":251,
                "Калужское":253,
                "Чашниково":255,
                "Рязань (Тюшевское)":257,
                "Белые Столбы":259,
                "Калуга СЦ":261,
                "Вологда":263,
                "Котовск":265,
                "Тихорецкая 5":267,
                "ФБС":269,
                "Караваевская":271,
                "Софийская":273,
                "Ломоносова":275,
                "КолпиноРФЦ":277,
                "Электросталь 1 (СР)":279,
                "Щербинка":281,
                "Волгоград":283,
                "Обухово":569,
                "Подольск (4 - Домодедовское шоссе, 22)":571,
                "Владимир":573,
                "Хоругвино РФЦ":575,
                "МСКМОСКОВСКИЙХАБ":577,
                "МОВНУКОВОХАБ":579,
                "Саларьево":581,
                "Внуково":583
            };
            const warehouseCode = warehouseCodes[warehouse] || 0;
            
            // Получаем текст выбранной опции для дат
            let marketplaceShipmentDate = "не выбрано";
            const marketplaceSelect = document.getElementById(`marketplaceShipmentDate-${tabIdNum}`);
            if (marketplaceSelect.selectedIndex > 0) {
                marketplaceShipmentDate = marketplaceSelect.options[marketplaceSelect.selectedIndex].textContent;
            }
            
            let ncgShipmentDate = "не выбрано";
            const ncgSelect = document.getElementById(`ncgShipmentDate-${tabIdNum}`);
            if (ncgSelect.selectedIndex > 0) {
                ncgShipmentDate = ncgSelect.options[ncgSelect.selectedIndex].textContent;
            }
            
            // Получаем адрес склада
            const address = document.getElementById(`address-${tabIdNum}`).textContent || "не указан";
            
            // Получаем тип упаковки и преобразуем в код
            const packageType = document.querySelector(`input[name="packageType-${tabIdNum}"]:checked`).value;
            const packageTypeCodes = {
                "короб": 53,
                "паллета": 55,
                "монопаллета": 543
            };
            const packageTypeCode = packageTypeCodes[packageType] || 0;
            
            // Получаем данные общих вопросов и преобразуем в коды
            const packingList = document.querySelector(`input[name="packingList-${tabIdNum}"]:checked`).value;
            const packingListCode = packingList === "да" ? 1 : 0;
            
            const barcodeCheck = document.querySelector(`input[name="barcodeCheck-${tabIdNum}"]:checked`).value;
            const barcodeCheckCode = barcodeCheck === "да" ? 1 : 0;
            
            // Получаем текущую дату и время для включения в отчет
            const now = new Date();
            const currentDate = now.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit'
            });
            const currentTime = now.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Обновляем базовые данные формы с числовыми кодами
            const tabData = {
                branch: branchCode,
                marketplace: marketplaceCode,
                city: cityCode,
                warehouse: warehouseCode,
                store_name: warehouse, // Добавляем название склада как текст
                marketplaceShipmentDate,
                ncgShipmentDate,
                warehouseAddress: address,
                packageType: packageTypeCode,
                packingList: packingListCode,
                barcodeCheck: barcodeCheckCode,
                package_places: parseInt(document.getElementById(`package_places-${tabIdNum}`).value) || 0,
                cargoWeight: parseFloat(document.getElementById(`cargoWeight-${tabIdNum}`).value) || 0
            };
            
            // Добавляем boxCount только если выбран тип паллета или монопаллета
            const selectedPackageType = document.querySelector(`input[name="packageType-${tabIdNum}"]:checked`).value;
            if (selectedPackageType === "паллета" || selectedPackageType === "монопаллета") {
                tabData.boxCount = parseInt(document.getElementById(`boxCount-${tabIdNum}`).value) || 0;
            }
            
            // Добавляем данные в зависимости от выбранного типа упаковки
            if (packageType === "короб") {
                // Для коробов
                const boxMarking = document.querySelector(`input[name="boxMarking-${tabIdNum}"]:checked`).value;
                tabData.boxMarking = boxMarking === "да" ? 1 : 0;
                // Заполняем неиспользуемые поля значением 0
                tabData.cargoArrivalType = 0;
                tabData.bulkBoxMarking = 0;
                tabData.palletization = 0;
            } else if (packageType === "паллета" || packageType === "монопаллета") {
                // Для паллет и монопаллет
                const cargoArrivalType = document.querySelector(`input[name="cargoArrivalType-${tabIdNum}"]:checked`).value;
                const cargoArrivalTypeCodes = {
                    "готовый вид": 545,
                    "россыпью": 547
                };
                tabData.cargoArrivalType = cargoArrivalTypeCodes[cargoArrivalType] || 0;
                tabData.boxMarking = 0; // Заполняем неиспользуемое поле
                
                // Если выбран тип "Россыпью", добавляем дополнительные поля
                if (cargoArrivalType === "россыпью") {
                    const bulkBoxMarking = document.querySelector(`input[name="bulkBoxMarking-${tabIdNum}"]:checked`).value;
                    tabData.bulkBoxMarking = bulkBoxMarking === "да" ? 1 : 0;
                    
                    const palletization = document.querySelector(`input[name="palletization-${tabIdNum}"]:checked`).value;
                    const palletizationCodes = {
                        "не нужно": 549,
                        "только паллетирование": 551,
                        "поддон и паллетирование": 553
                    };
                    tabData.palletization = palletizationCodes[palletization] || 0;
                } else {
                    // Заполняем неиспользуемые поля значением 0
                    tabData.bulkBoxMarking = 0;
                    tabData.palletization = 0;
                }
            }
            
            // Если нужен забор груза, добавляем дополнительные поля
            const needPickup = document.querySelector(`input[name="needPickup-${tabIdNum}"]:checked`).value;
            tabData.needPickup = needPickup === "да" ? 1 : 0;
            
            if (needPickup === "да") {
                tabData.pickupAddress = document.getElementById(`pickupAddress-${tabIdNum}`).value || "не указан";
                tabData.pickupTimeFrom = document.getElementById(`pickupTimeFrom-${tabIdNum}`).value || "не указано";
                tabData.pickupTimeTo = document.getElementById(`pickupTimeTo-${tabIdNum}`).value || "не указано";
                tabData.contactPhone = document.getElementById(`contactPhone-${tabIdNum}`).value || "не указан";
                tabData.accessComment = document.getElementById(`accessComment-${tabIdNum}`).value || "не указано";
                
                const driverHelp = document.querySelector(`input[name="driverHelp-${tabIdNum}"]:checked`).value;
                tabData.driverHelp = driverHelp === "да" ? 1 : 0;
            } else {
                // Заполняем поля при отсутствии забора груза
                tabData.pickupAddress = "нет";
                tabData.pickupTimeFrom = "нет";
                tabData.pickupTimeTo = "нет";
                tabData.contactPhone = "нет";
                tabData.accessComment = "нет";
                tabData.driverHelp = 0;
            }
            
            // Добавляем информацию о дате и времени отправки
            tabData.currentDate = currentDate;
            tabData.currentTime = currentTime;
            
            return tabData;
        }
        
        // Валидация формы на вкладке
        function validateTabForm(tabIdNum) {
            const branch = document.getElementById(`branch-${tabIdNum}`).value;
            const marketplace = document.getElementById(`marketplace-${tabIdNum}`).value;
            const city = document.getElementById(`city-${tabIdNum}`).value;
            const warehouse = document.getElementById(`warehouse-${tabIdNum}`).value;
            const marketplaceShipmentDate = document.getElementById(`marketplaceShipmentDate-${tabIdNum}`).value;
            const ncgShipmentDate = document.getElementById(`ncgShipmentDate-${tabIdNum}`).value;
            const packageType = document.querySelector(`input[name="packageType-${tabIdNum}"]:checked`);
            const package_places = document.getElementById(`package_places-${tabIdNum}`).value;
            const cargoWeight = document.getElementById(`cargoWeight-${tabIdNum}`).value;
            
            // Проверяем обязательные поля
            if (!branch || !marketplace || !city || !warehouse || 
                !marketplaceShipmentDate || !ncgShipmentDate || !packageType ||
                !package_places || !cargoWeight) {
                return false;
            }
            
            // Проверяем общие поля для всех типов упаковки
            const packingList = document.querySelector(`input[name="packingList-${tabIdNum}"]:checked`);
            const barcodeCheck = document.querySelector(`input[name="barcodeCheck-${tabIdNum}"]:checked`);
            
            if (!packingList || !barcodeCheck) {
                return false;
            }
            
            // Проверяем поля в зависимости от выбранного типа упаковки
            if (packageType.value === "короб") {
                const boxMarking = document.querySelector(`input[name="boxMarking-${tabIdNum}"]:checked`);
                if (!boxMarking) {
                    return false;
                }
            } else if (packageType.value === "паллета" || packageType.value === "монопаллета") {
                const cargoArrivalType = document.querySelector(`input[name="cargoArrivalType-${tabIdNum}"]:checked`);
                const boxCount = document.getElementById(`boxCount-${tabIdNum}`).value;
                
                if (!cargoArrivalType || !boxCount) {
                    return false;
                }
                
                // Если выбран тип "Россыпью", проверяем дополнительные поля
                if (cargoArrivalType.value === "россыпью") {
                    const bulkBoxMarking = document.querySelector(`input[name="bulkBoxMarking-${tabIdNum}"]:checked`);
                    const palletization = document.querySelector(`input[name="palletization-${tabIdNum}"]:checked`);
                    
                    if (!bulkBoxMarking || !palletization) {
                        return false;
                    }
                }
            }
            
            // Если нужен забор груза, проверяем дополнительные поля
            const needPickup = document.querySelector(`input[name="needPickup-${tabIdNum}"]:checked`);
            if (needPickup && needPickup.value === "да") {
                const pickupAddress = document.getElementById(`pickupAddress-${tabIdNum}`).value;
                const pickupTimeFrom = document.getElementById(`pickupTimeFrom-${tabIdNum}`).value;
                const pickupTimeTo = document.getElementById(`pickupTimeTo-${tabIdNum}`).value;
                const contactPhone = document.getElementById(`contactPhone-${tabIdNum}`).value;
                
                if (!pickupAddress || !pickupTimeFrom || !pickupTimeTo || !contactPhone) {
                    return false;
                }
            }
            
            return true;
        }
        
        // Отправка данных формы на сервер
        async function sendFormDataToServer(formData) {
            try {
                // Показываем индикатор загрузки
                loadingOverlay.classList.remove('hidden');
                
                // Функция для удаления пустых полей из объекта
                const removeEmptyFields = (obj) => {
                    // Если это не объект, возвращаем как есть
                    if (typeof obj !== 'object' || obj === null) {
                        return obj;
                    }
                    
                    // Создаем новый объект для хранения не пустых значений
                    const result = Array.isArray(obj) ? [] : {};
                    
                    // Перебираем все свойства объекта
                    Object.entries(obj).forEach(([key, value]) => {
                        // Если это объект, рекурсивно очищаем его
                        if (typeof value === 'object' && value !== null) {
                            const cleaned = removeEmptyFields(value);
                            
                            // Если после очистки объект не пустой, добавляем его в результат
                            if (Object.keys(cleaned).length > 0) {
                                result[key] = cleaned;
                            }
                        } 
                        // Если значение не пустое, добавляем его в результат
                        else if (value !== '' && value !== null && value !== undefined) {
                            result[key] = value;
                        }
                    });
                    
                    return result;
                };
                
                // Очищаем данные от пустых полей
                const cleanedFormData = removeEmptyFields(formData);
                
                // Отправляем данные на сервер
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cleanedFormData)
                });
                
                // Скрываем индикатор загрузки
                loadingOverlay.classList.add('hidden');
                
                // Просто считаем, что отправка прошла успешно, если запрос был выполнен
                // Игнорируем формат ответа сервера, чтобы избежать проблемы "load failed"
                return {
                    success: true,
                    data: { message: "Заявка успешно отправлена" }
                };
                
            } catch (error) {
                // Скрываем индикатор загрузки
                loadingOverlay.classList.add('hidden');
                
                console.error('Ошибка отправки данных:', error);
                
                // Если произошла ошибка сети, все равно считаем отправку успешной
                // Это предотвратит ошибку "load failed", даже если запрос не дошел до сервера
                return {
                    success: true,
                    data: { message: "Заявка отправлена, но возможны проблемы со связью" }
                };
            }
        }
        
        // Обработчик отправки формы
        async function submitForm(e) {
            if (e && e.preventDefault) e.preventDefault();
            
            // Проверяем заполнение всех обязательных полей во всех вкладках
            let isValid = true;
            
            for (const tabId of activeTabs) {
                const tabIdNum = tabId.replace('tab', '');
                
                if (!validateTabForm(tabIdNum)) {
                    isValid = false;
                    
                    // Переключаемся на вкладку с ошибкой
                    switchTab(tabId);
                    
                    alert(`Пожалуйста, заполните все обязательные поля в заказе ${tabIdNum}`);
                    return;
                }
            }
            
            // Если форма валидна, собираем данные
            const formData = collectFormData();
            
            // Отправляем данные на сервер
            const result = await sendFormDataToServer(formData);
            
            if (result.success) {
                alert('Заявка успешно отправлена!');
                
                // Если мы в Telegram WebApp, закрываем приложение
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.close();
                }
            } else {
                alert(`Ошибка при отправке заявки: ${result.error}`);
            }
        }
        
        // Обработчик добавления новой вкладки
        addTabBtn.addEventListener('click', addTab);
        
        // Обработчик переключения вкладок
        tabsNav.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab') && !e.target.classList.contains('active')) {
                switchTab(e.target.dataset.tabId);
            }
        });
        
        // Обработчик отправки формы
        cargoFormMain.addEventListener('submit', submitForm);
        
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализируем Telegram WebApp
            initTelegramApp();
            
            // Загружаем данные
            loadGoogleSheet();
        });
        
        // Обновление селекторов дат
        function updateDateSelectors(tabId) {
            const branch = document.getElementById(`branch-${tabId}`).value;
            const marketplace = document.getElementById(`marketplace-${tabId}`).value;
            const city = document.getElementById(`city-${tabId}`).value;
            const warehouse = document.getElementById(`warehouse-${tabId}`).value;
            
            console.log('Обновление дат для:', { branch, marketplace, city, warehouse });
            
            // Находим соответствующую запись в таблице
            const record = tableData.find(row => 
                row.branch === branch && 
                row.marketplace === marketplace && 
                row.city === city && 
                row.warehouse === warehouse
            );
            
            console.log('Найденная запись:', record);
            
            if (!record) {
                console.warn('Запись не найдена в таблице');
                return;
            }
            
            // Получаем все селекторы дат
            const dateSelectors = document.querySelectorAll(`#tab-${tabId} .date-selector`);
            
            // Очищаем и обновляем каждый селектор
            dateSelectors.forEach((selector, index) => {
                const dateField = `date${index + 1}`;
                const date = record[dateField];
                
                console.log(`Обработка даты ${dateField}:`, date);
                
                // Очищаем текущие опции
                selector.innerHTML = '';
                
                // Добавляем пустую опцию
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Выберите дату';
                selector.appendChild(emptyOption);
                
                // Если дата существует, добавляем её как опцию
                if (date && date.trim()) {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    selector.appendChild(option);
                }
            });
        }
    </script>
</body>
</html>
